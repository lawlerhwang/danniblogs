name: Auto Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    # Skip if this commit is from standard-version itself
    if: "!contains(github.event.head_commit.message, 'chore(release)')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get last tag
        id: get-tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "Last tag: $LAST_TAG"

      - name: Check commits since last tag
        id: check-commits
        run: |
          LAST_TAG="${{ steps.get-tag.outputs.last_tag }}"
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" --no-merges)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Determine version bump type from commits
          if echo "$COMMITS" | grep -q "BREAKING CHANGE"; then
            echo "bump_type=major" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE "^feat:"; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE "^(fix|perf|refactor):"; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          else
            echo "bump_type=none" >> $GITHUB_OUTPUT
            echo "No version-bumping commits found (docs/style/ci/build/test commits don't trigger releases)"
          fi

      - name: Run standard-version
        if: steps.check-commits.outputs.bump_type != 'none'
        run: |
          BUMP_TYPE="${{ steps.check-commits.outputs.bump_type }}"
          npm run "release:$BUMP_TYPE"

      - name: Get new version
        if: steps.check-commits.outputs.bump_type != 'none'
        id: get-version
        run: |
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Push changes and tags
        if: steps.check-commits.outputs.bump_type != 'none'
        run: |
          git push --follow-tags origin main
          # release.yml workflow will create GitHub Release when tag is pushed

